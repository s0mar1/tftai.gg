name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° íƒ€ì… ì²´í¬
  test-and-lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install

      - name: Build shared package
        run: pnpm build:shared

      - name: Run tests and linting in parallel
        run: |
          # ë™ì‹œ ì‹¤í–‰ìœ¼ë¡œ CI ì‹œê°„ ë‹¨ì¶•
          pnpm test:backend &
          pnpm test:frontend &
          pnpm lint:backend &
          pnpm lint:frontend &
          wait

      - name: Run type checking
        run: pnpm type-check

      - name: Build packages in parallel
        run: |
          # ë¹Œë“œ ì‘ì—… ë™ì‹œ ì‹¤í–‰
          pnpm build:backend &
          pnpm build:frontend &
          wait

  # E2E í…ŒìŠ¤íŠ¸ (ë³„ë„ ì›Œí¬í”Œë¡œìš° ì°¸ì¡°)
  call-e2e-tests:
    needs: test-and-lint
    uses: ./.github/workflows/e2e-tests.yml
    secrets: inherit

  # ë°°í¬ ì¤€ë¹„ (ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ í›„)
  deploy-ready:
    needs: [test-and-lint, call-e2e-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deployment ready notification
        run: |
          echo "ğŸ‰ All tests passed! Ready for deployment"
          echo "âœ… Unit tests: Passed"
          echo "âœ… Linting: Passed"
          echo "âœ… Type checking: Passed"
          echo "âœ… Build: Passed"
          echo "âœ… E2E tests: Passed"